<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <title>ETfinder2 · SSAP/SSB Pipeline</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 24px; }
    h1 { margin: 0 0 16px 0; }
    .card { border:1px solid #e5e7eb; border-radius:12px; padding:16px; margin-bottom:16px; background:#fff; }
    .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    label { display:flex; gap:8px; align-items:center; }
    input[type=text] { padding:8px 10px; border:1px solid #cbd5e1; border-radius:8px; min-width:240px; }
    .radio { display:flex; gap:12px; }
    button { padding:8px 14px; border:1px solid #cbd5e1; border-radius:8px; background:#111827; color:#fff; cursor:pointer; }
    button:hover { background:#0b1220; }
    .pill { font-size:12px; padding:4px 8px; border-radius:999px; background:#f3f4f6; }
    .muted { color:#6b7280; font-size:12px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    pre { background:#0b1020; color:#d2e3ff; padding:12px; border-radius:8px; overflow:auto; font-size:12px; line-height:1.3; }
    details { margin-top:8px; }
    summary { cursor:pointer; font-weight:600; }
    .pfam-tag { display:inline-block; margin:2px 6px 2px 0; padding:2px 6px; font-size:12px; border-radius:6px; background:#eef2ff; color:#3730a3; }
    .ctx-card { border:1px dashed #e2e8f0; padding:10px; border-radius:8px; margin-top:8px; background:#fafafa; }
    .ctx-title { font-weight:600; font-size:13px; color:#334155; margin-bottom:4px; }
    .filters { display:flex; gap:16px; align-items:center; margin:12px 0 20px; padding:10px 12px; border:1px solid #e5e7eb; border-radius:12px; background:#fafafa; }
    .hidden { display:none !important; }
  </style>
</head>
<body>
  <h1>ETfinder2 · SSAP/SSB Pipeline</h1>

  <!-- 表单 -->
  <div class="card">
    <form method="post" action="/run">
      <div class="row">
        <label>SSB 尾巴（suffix）：
          <input type="text" name="suffix" value="{{ suffix_default or 'FDDEIPF' }}" placeholder="如：FDDEIPF" />
        </label>
        <label>目标物种（可选）：
          <input type="text" name="target" value="{{ target_default or '' }}" placeholder="如：Bacillus subtilis 或 1423" />
        </label>
        <div class="radio">
          <label><input type="radio" name="mode" value="rep" {{ 'checked' if (mode_default=='rep') else '' }}/> 仅 rep（推荐）</label>
          <label><input type="radio" name="mode" value="all" {{ 'checked' if (mode_default=='all') else '' }}/> 全量（rep+member）</label>
        </div>
        <button type="submit">运行</button>
      </div>
      <div class="muted" style="margin-top:6px;">
        只需填写前两个参数，其余使用默认设置；运行完毕后会在下方展示两棵树与提取的 JSON。
      </div>
    </form>
  </div>

  {% if ran %}
    <div class="card">
      <h2 style="margin-top:0">运行结果</h2>
      {% if ok %}
        <p class="pill">状态：成功</p>
      {% else %}
        <p class="pill" style="background:#fee2e2; color:#991b1b;">状态：失败</p>
      {% endif %}

      <details open>
        <summary>控制台输出（stdout）</summary>
        <pre>{{ stdout }}</pre>
      </details>
      {% if stderr %}
      <details>
        <summary>控制台错误（stderr）</summary>
        <pre>{{ stderr }}</pre>
      </details>
      {% endif %}
    </div>

    <div class="card">
      <h2 style="margin-top:0">树文件</h2>
      <ul>
        <li>
          SSAP 蛋白树（{{ mode_default == 'rep' and 'rep-only' or 'all' }}）：
          {% if ssap_exists %}
            <a class="pill" href="{{ ssap_url }}">下载 .nwk</a>
            <details>
              <summary>查看 Newick 文本</summary>
              <pre id="ssap-nwk">（点击下载后本地查看更佳；此处仅建议快速预览）</pre>
            </details>
          {% else %}
            <span class="muted">未找到输出文件</span>
          {% endif %}
        </li>
        <li>
          Taxon 物种树：
          {% if taxon_exists %}
            <a class="pill" href="{{ taxon_url }}">下载 .nwk</a>
            <details>
              <summary>查看 Newick 文本</summary>
              <pre id="taxon-nwk">（点击下载后本地查看更佳；此处仅建议快速预览）</pre>
            </details>
          {% else %}
            <span class="muted">未找到输出文件</span>
          {% endif %}
        </li>
      </ul>
      <div class="muted">* 如需交互式树可后续集成 phylotree.js 等前端库；当前先提供下载与快速预览。</div>
    </div>

    <div class="card">
      <h2 style="margin-top:0">Clusters（来自 {{ suffix_default }}_ssap_clusters.json）</h2>

      <!-- 筛选控件 -->
      <div class="filters">
        <strong>筛选：</strong>
        <label><input type="checkbox" id="filter-ssb"> SSB（PF00436.28_SSB）</label>
        <label><input type="checkbox" id="filter-exo">
          Exonuclease partner（PF12684.10_DUF3799 / PF12705.10_PDDEXK_1 / PF09588.13_YqaJ）
        </label>
        <span class="muted">勾选后仅显示满足条件的簇；两个都勾选表示“同时满足”。</span>
      </div>

      {% if not clusters %}
        <p class="muted">没有数据。</p>
      {% endif %}

      {% for cluster_name, cluster in clusters.items() %}
        {% set rep = cluster.get('rep') %}
        {% set members = cluster.get('members', []) %}
        <div class="cluster" id="{{ cluster_name }}">
          <div class="row">
            <h3 style="margin:0;">{{ cluster_name }}</h3>
            <span class="pill">rep: {{ cluster_name }}-{{ rep.number if rep and rep.number is not none else '?' }}</span>
            {% if rep %}
              <span class="pill">WP: {{ rep.id }}</span>
            {% endif %}
            <span class="pill">rep identity: {{ (rep.identity if rep and rep.identity is not none else '-') }}</span>
            <span class="pill">{{ members|length }} member{{ '' if members|length == 1 else 's' }}</span>
          </div>

          {% if rep and rep.get('ctx') %}
            <details open>
              <summary>
                <span class="mono">{{ cluster_name }}-{{ rep.number if rep.number is not none else '?' }}</span>
                · Representative · <span class="mono">{{ rep.id }}</span>
              </summary>

              {% set rep_pfams = [] %}
              {% if rep.ctx.get('context_elements') %}
                {% for row in rep.ctx['context_elements'] %}
                  {% for pf in row %}
                    {% if pf not in rep_pfams %}
                      {% set _ = rep_pfams.append(pf) %}
                    {% endif %}
                  {% endfor %}
                {% endfor %}
              {% endif %}
              {% if rep_pfams %}
                <div class="block">
                  {% for pf in rep_pfams %}
                    <span class="pfam-tag">{{ pf }}</span>
                  {% endfor %}
                </div>
              {% endif %}

              {% for key in ['ctx_-2','ctx_-1','ctx_0','ctx_+1','ctx_+2'] %}
                {% if rep.ctx.get(key) %}
                  <div class="ctx-card">
                    <div class="ctx-title">{{ key }}</div>
                    <div class="row" style="margin:6px 0;">
                      <button onclick="copyPre(this)">复制本段 FASTA</button>
                    </div>
<pre>{%- for entry in rep.ctx[key] -%}
{%- set acc = entry.get('accession','NA') -%}
{%- set desc = entry.get('description','')|dedupe_desc(acc) -%}
>{{ acc }} {{ desc }}
{{ entry.get('sequence','') | wrap60 }}
{%- endfor -%}</pre>
                  </div>
                {% endif %}
              {% endfor %}
            </details>
          {% else %}
            <p class="muted">（代表序列没有可显示的上下文）</p>
          {% endif %}

          {% if members %}
            <details>
              <summary>Members（共 {{ members|length }} 个）</summary>
              {% for m in members %}
                <div class="block">
                  <div class="row">
                    <span class="pill">id: {{ cluster_name }}-{{ m.number if m.number is not none else '?' }}</span>
                    <span class="pill">WP: {{ m.id }}</span>
                    <span class="pill">identity: {{ m.identity if m.identity is not none else '-' }}</span>
                  </div>

                  {% if m.get('ctx') %}
                    {% set m_pfams = [] %}
                    {% if m.ctx.get('context_elements') %}
                      {% for row in m.ctx['context_elements'] %}
                        {% for pf in row %}
                          {% if pf not in m_pfams %}
                            {% set _ = m_pfams.append(pf) %}
                          {% endif %}
                        {% endfor %}
                      {% endfor %}
                    {% endif %}
                    {% if m_pfams %}
                      <div class="block">
                        {% for pf in m_pfams %}
                          <span class="pfam-tag">{{ pf }}</span>
                        {% endfor %}
                      </div>
                    {% endif %}

                    {% for key in ['ctx_-2','ctx_-1','ctx_0','ctx_+1','ctx_+2'] %}
                      {% if m.ctx.get(key) %}
                        <div class="ctx-card">
                          <div class="ctx-title">{{ key }}</div>
                          <div class="row" style="margin:6px 0;">
                            <button onclick="copyPre(this)">复制本段 FASTA</button>
                          </div>
<pre>{%- for entry in m.ctx[key] -%}
{%- set acc = entry.get('accession','NA') -%}
{%- set desc = entry.get('description','')|dedupe_desc(acc) -%}
>{{ acc }} {{ desc }}
{{ entry.get('sequence','') | wrap60 }}
{%- endfor -%}</pre>
                        </div>
                      {% endif %}
                    {% endfor %}
                  {% else %}
                    <p class="muted">（该 member 无 ctx）</p>
                  {% endif %}
                </div>
              {% endfor %}
            </details>
          {% endif %}
        </div>
      {% endfor %}
    </div>

    <script>
      // 复制优化：去掉行尾空白，最多保留 2 个连续空行
      function copyPre(btn) {
        const pre = btn.closest('.ctx-card').querySelector('pre');
        let text = pre.innerText.replace(/[ \t]+$/gm, "").replace(/\n{3,}/g, "\n\n").trim();
        navigator.clipboard.writeText(text).then(()=>{
          btn.textContent = "已复制";
          setTimeout(()=>btn.textContent="复制本段 FASTA", 1000);
        }).catch(()=>{
          btn.textContent = "复制失败";
          setTimeout(()=>btn.textContent="复制本段 FASTA", 1000);
        });
      }

      // 加载两个 .nwk 的预览（仅当下载地址存在时）
      (async () => {
        const ssap = document.getElementById('ssap-nwk');
        const taxon = document.getElementById('taxon-nwk');
        // 预览仅用于快速看文本；浏览器会把下载 URL 当成附件，不一定能直接 fetch。
        // 这里尝试 fetch，如果失败则忽略（仍可点击下载）。
        try {
          const u = new URL("{{ ssap_url|default('', true) }}", window.location.href);
          const r = await fetch(u, {headers:{'Accept':'text/plain'}, cache:'no-store'});
          if (r.ok) ssap.textContent = await r.text();
        } catch(e){}
        try {
          const u2 = new URL("{{ taxon_url|default('', true) }}", window.location.href);
          const r2 = await fetch(u2, {headers:{'Accept':'text/plain'}, cache:'no-store'});
          if (r2.ok) taxon.textContent = await r2.text();
        } catch(e){}
      })();

      // ====== JSON 筛选（/data/<suffix>）======
      const SSB_PFAM = "PF00436.28_SSB";
      const EXO_LIST = new Set(["PF12684.10_DUF3799","PF12705.10_PDDEXK_1","PF09588.13_YqaJ","PF12684.10_DUF3799/PF12705.10_PDDEXK_1"]);

      function collectPfamsFromNode(node) {
        const out = new Set();
        const pushToken = (tok) => {
          if (!tok) return; out.add(tok);
          if (tok.includes("/")) tok.split("/").forEach(x => out.add(x.trim()));
        };
        if (!node) return out;
        const ctx = node.ctx || {};
        const ce = ctx.context_elements || [];
        ce.forEach(row => (row || []).forEach(pushToken));
        const matched = ctx.matched_pfams || [];
        matched.forEach(pushToken);
        return out;
      }

      function clusterHasExo(pfamsSet) {
        for (const x of EXO_LIST) if (pfamsSet.has(x)) return true;
        return false;
      }

      async function buildPfamIndexAndBindFilters() {
        const res = await fetch("{{ data_url|default('', true) }}");
        if (!res.ok) return;
        const data = await res.json();

        Object.entries(data).forEach(([cName, cVal]) => {
          const el = document.getElementById(cName);
          if (!el) return;
          const pfams = new Set();
          if (cVal.rep) collectPfamsFromNode(cVal.rep).forEach(x => pfams.add(x));
          (cVal.members || []).forEach(m => collectPfamsFromNode(m).forEach(x => pfams.add(x)));
          el.dataset.hasSsb = pfams.has(SSB_PFAM) ? "1" : "0";
          el.dataset.hasExo = clusterHasExo(pfams) ? "1" : "0";
        });

        const cbSSB = document.getElementById("filter-ssb");
        const cbExo = document.getElementById("filter-exo");
        const applyFilter = () => {
          const needSSB = cbSSB.checked;
          const needExo = cbExo.checked;
          document.querySelectorAll(".cluster").forEach(el => {
            const okSSB = el.dataset.hasSsb === "1";
            const okExo = el.dataset.hasExo === "1";
            let show = true;
            if (needSSB && !okSSB) show = false;
            if (needExo && !okExo) show = false;
            el.classList.toggle("hidden", !show);
          });
        };
        cbSSB.addEventListener("change", applyFilter);
        cbExo.addEventListener("change", applyFilter);
        applyFilter();
      }
      buildPfamIndexAndBindFilters().catch(()=>{});
    </script>
  {% endif %}
</body>
</html>