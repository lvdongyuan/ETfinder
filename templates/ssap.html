{% extends "base.html" %}
{% set body_class = "wide" %}
{% set container_class = "wide" %}
{% block title %}SSAP/SSB Context Viewer{% endblock %}

{% block content %}
  <h1>SSAP/SSB Context Viewer</h1>

  <!-- Filters -->
  <div class="filters card row">
    <label class="row">
      <input type="checkbox" id="filter-ssb">
      <span>SSB (PF00436.28_SSB)</span>
    </label>
    <label class="row">
      <input type="checkbox" id="filter-exo">
      <span>Exonuclease partner (PF12684.10_DUF3799 / PF12705.10_PDDEXK_1 / PF09588.13_YqaJ)</span>
    </label>
    <span class="muted" style="margin-left:auto;">Checked items are required; checking both means “must have both”.</span>
  </div>

  {% if not clusters %}
    <p class="muted">No data.</p>
  {% endif %}

{% set iter_clusters = clusters_pairs if clusters_pairs is defined else clusters.items() %}
{% for cl_name, cl in iter_clusters %}
  {% set rep = cl.get('rep') %}
  {% set members = cl.get('members', []) %}

  {# -------- collect PFAM tags (rep + members) -------- #}
  {% set pfams = [] %}
  {% macro add_pfams_from_ctx(ctx) -%}
    {%- if ctx and ctx.get('context_elements') -%}
      {%- for row in ctx['context_elements'] -%}
        {%- for pf in row -%}
          {%- if pf not in pfams -%}{%- set _ = pfams.append(pf) -%}{%- endif -%}
          {%- if "/" in pf -%}
            {%- for tok in pf.split("/") -%}
              {%- set t = tok.strip() -%}
              {%- if t and t not in pfams -%}{%- set _ = pfams.append(t) -%}{%- endif -%}
            {%- endfor -%}
          {%- endif -%}
        {%- endfor -%}
      {%- endfor -%}
    {%- endif -%}
  {%- endmacro %}

  {% if rep %}{{ add_pfams_from_ctx(rep.get('ctx')) }}{% endif %}
  {% for m in members %}{{ add_pfams_from_ctx(m.get('ctx')) }}{% endfor %}

  {% set has_ssb = 'PF00436.28_SSB' in pfams %}
  {% set exo_list = ['PF12684.10_DUF3799','PF12705.10_PDDEXK_1','PF09588.13_YqaJ'] %}
  {% set has_exo = (exo_list[0] in pfams) or (exo_list[1] in pfams) or (exo_list[2] in pfams) %}

  <section class="cluster section" id="{{ cl_name }}" data-has-ssb="{{ 1 if has_ssb else 0 }}" data-has-exo="{{ 1 if has_exo else 0 }}">
    <div class="row" style="align-items:baseline; gap:12px;">
      <h2 style="margin:0;">{{ cl_name }}</h2>
      <span class="chip">rep: {{ cl_name }}-{{ rep.number if rep and rep.number is not none else '?' }}</span>
      {% if rep %}<span class="chip">ID: {{ rep.id }}</span>{% endif %}
      <span class="chip">rep identity: {{ rep.identity if rep and rep.identity is not none else '-' }}</span>
      <span class="chip">{{ members|length }} members</span>
      {% if has_ssb %}<span class="chip ok">SSB</span>{% endif %}
      {% if has_exo %}<span class="chip ok">Exo</span>{% endif %}
    </div>

    <!-- ===== Representative ===== -->
    {% if rep and rep.get('ctx') %}
      <details open>
        <summary class="summary">Representative · ID: <span class="mono">{{ rep.id }}</span></summary>

        {# one-line list of PFAMs for rep #}
        {% set rep_pf = [] %}
        {% if rep.ctx.get('context_elements') %}
          {% for row in rep.ctx['context_elements'] %}
            {% for pf in row %}
              {% if pf not in rep_pf %}{% set _ = rep_pf.append(pf) %}{% endif %}
            {% endfor %}
          {% endfor %}
        {% endif %}
        {% if rep_pf %}
          <div class="row" style="gap:6px; margin:8px 0;">
            {% for pf in rep_pf %}<span class="pfam">{{ pf }}</span>{% endfor %}
          </div>
        {% endif %}

        <!-- horizontal context strip -->
        <div class="ctx-strip">
          {% for key in ['ctx_-2','ctx_-1','ctx_0','ctx_+1','ctx_+2'] %}
            {% if rep.ctx.get(key) %}
              <div class="ctx-card">
                <div class="ctx-head">
                  <span class="ctx-title">{{ key }}</span>
                  <button class="btn btn-sm" onclick="copyPre(this)">Copy FASTA</button>
                </div>
<pre class="ctx-pre">{%- for entry in rep.ctx[key] -%}
>{{ entry.get('accession','NA') }} {{ entry.get('description','')|dedupe_desc(entry.get('accession','')) }}
{{ entry.get('sequence','') | wrap60 }}
{%- endfor -%}</pre>
              </div>
            {% endif %}
          {% endfor %}
        </div>
      </details>
    {% else %}
      <p class="muted">(no representative context)</p>
    {% endif %}

    <!-- ===== Members ===== -->
    {% if members %}
      <details>
        <summary class="summary">Members ({{ members|length }})</summary>
        {% for m in members %}
          <div class="card soft" style="margin-top:10px;">
            <div class="row">
              <span class="chip">id: {{ cl_name }}-{{ m.number if m.number is not none else '?' }}</span>
              <span class="chip">ID: {{ m.id }}</span>
              <span class="chip">identity: {{ m.identity if m.identity is not none else '-' }}</span>
            </div>

            {% if m.get('ctx') %}
              {% set m_pf = [] %}
              {% if m.ctx.get('context_elements') %}
                {% for row in m.ctx['context_elements'] %}
                  {% for pf in row %}
                    {% if pf not in m_pf %}{% set _ = m_pf.append(pf) %}{% endif %}
                  {% endfor %}
                {% endfor %}
              {% endif %}
              {% if m_pf %}
                <div class="row" style="gap:6px; margin:8px 0;">
                  {% for pf in m_pf %}<span class="pfam">{{ pf }}</span>{% endfor %}
                </div>
              {% endif %}

              <div class="ctx-strip">
                {% for key in ['ctx_-2','ctx_-1','ctx_0','ctx_+1','ctx_+2'] %}
                  {% if m.ctx.get(key) %}
                    <div class="ctx-card">
                      <div class="ctx-head">
                        <span class="ctx-title">{{ key }}</span>
                        <button class="btn btn-sm" onclick="copyPre(this)">Copy FASTA</button>
                      </div>
<pre class="ctx-pre">{%- for entry in m.ctx[key] -%}
>{{ entry.get('accession','NA') }} {{ entry.get('description','')|dedupe_desc(entry.get('accession','')) }}
{{ entry.get('sequence','') | wrap60 }}
{%- endfor -%}</pre>
                    </div>
                  {% endif %}
                {% endfor %}
              </div>
            {% else %}
              <p class="muted">(no context)</p>
            {% endif %}
          </div>
        {% endfor %}
      </details>
    {% endif %}
  </section>
{% endfor %}

<!-- Local styles for horizontal context strip -->
<style>
  .ctx-strip{
    display:grid;
    grid-template-columns: repeat(5, minmax(280px, 1fr));
    gap:12px;
    margin-top:10px;
  }
  @media (max-width:1500px){
    .ctx-strip{ grid-template-columns: repeat(3, minmax(280px, 1fr)); }
  }
  @media (max-width:980px){
    .ctx-strip{ grid-template-columns: repeat(2, minmax(260px, 1fr)); }
  }
  .ctx-card{
    border:1px solid var(--border);
    background: color-mix(in srgb, var(--card) 94%, black 6%);
    border-radius:12px; padding:10px;
  }
  .ctx-head{ display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; }
  .ctx-title{ font-weight:600; letter-spacing:.2px; }
  .btn.btn-sm{ padding:4px 8px; font-size:.9em; }
  .ctx-pre{
    max-height: 320px;             /* 每格内部可滚动，不会撐太高 */
    overflow:auto;
    margin:0;
  }
  .pfam{ display:inline-block; padding:2px 6px; font-size:12px; border-radius:6px;
         background:#eef2ff; color:#3730a3; }
</style>

<script>
  // Copy helper: trim trailing spaces and collapse extra blank lines
  function copyPre(btn) {
    const pre = btn.closest('.ctx-card').querySelector('pre');
    let text = pre.innerText.replace(/[ \t]+$/gm, "").replace(/\n{3,}/g, "\n\n").trim();
    navigator.clipboard.writeText(text).then(()=>{
      const old = btn.textContent;
      btn.textContent = "Copied";
      setTimeout(()=>btn.textContent = old, 900);
    }).catch(()=>{
      const old = btn.textContent;
      btn.textContent = "Copy failed";
      setTimeout(()=>btn.textContent = old, 900);
    });
  }

  // Client-side filtering by data attributes
  const cbSSB = document.getElementById("filter-ssb");
  const cbExo = document.getElementById("filter-exo");
  function applyFilter(){
    const needSSB = cbSSB.checked, needExo = cbExo.checked;
    document.querySelectorAll(".cluster").forEach(el=>{
      const okSSB = el.dataset.hasSsb === "1";
      const okExo = el.dataset.hasExo === "1";
      let show = true;
      if (needSSB && !okSSB) show = false;
      if (needExo && !okExo) show = false;
      el.style.display = show ? "" : "none";
    });
  }
  cbSSB.addEventListener("change", applyFilter);
  cbExo.addEventListener("change", applyFilter);
  applyFilter();
</script>
{% endblock %}